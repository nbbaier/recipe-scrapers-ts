name: Migration Batch

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  migration-batch:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Sync test data
        run: bun run sync-test-data

      - name: Generate migration batch
        run: |
          # Ensure artifacts dir exists (prevents weird redirects / permission issues)
          mkdir -p artifacts
          bun run migration:batch -- --limit 5 --output artifacts/migration-batch.json

      - name: Read migration batch
        id: batch
        run: |
          domains=$(python - <<'PY'
          import json
          with open("artifacts/migration-batch.json", "r", encoding="utf-8") as fh:
              data = json.load(fh)
          print(",".join(data.get("selectedDomains", [])))
          PY
          )
          echo "domains=$domains" >> "$GITHUB_OUTPUT"

      - name: Create Copilot migration issue
        if: steps.batch.outputs.domains != ''
        env:
          GITHUB_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          DOMAINS: ${{ steps.batch.outputs.domains }}
        run: |
          body=$(cat <<'EOF'
          Nightly migration batch.

          Domains: ${DOMAINS}

          Instructions:
          - Use `artifacts/migration-batch.json` for the full batch context.
          - For each domain, find the corresponding Python scraper in the upstream repo.
          - Run `bun scripts/migrate-scraper.ts <scraper-name>` to generate the TypeScript scraper.
          - Ensure `src/scrapers/sites/index.ts` is updated.
          - Run `bun run build:quiet`.
          - Run `bun run validate-parity -- --domains <domain>` for each domain.
          - If a domain cannot be migrated automatically, add a note to `PARITY_ISSUES.md`.
          EOF
          )

          # Expand DOMAINS after the heredoc (because we used <<'EOF' to avoid accidental shell parsing)
          body="${body//'${DOMAINS}'/$DOMAINS}"

          export BODY="$body"
          python - <<'PY'
          import json
          import os

          payload = {
              "title": f"Migration batch: {os.environ['DOMAINS']}",
              "body": os.environ["BODY"],
              # Fix: do not set assignees to "Copilot" / copilot bot, since it cannot be assigned
              # (this was causing the HTTP 422 Validation Failed)
              # "assignees": ["copilot-swe-agent[bot]"],
              "agent_assignment": {
                  "target_repo": os.environ["REPO"],
                  "base_branch": "main",
                  "custom_instructions": "Use the existing migration tooling and keep changes scoped to the selected domains.",
                  "custom_agent": "",
                  "model": "gpt-5.2-codex",
              },
          }

          with open("artifacts/copilot-issue.json", "w", encoding="utf-8") as fh:
              json.dump(payload, fh)
          PY

          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${REPO}/issues \
            --input artifacts/copilot-issue.json

      - name: Upload batch artifact
        uses: actions/upload-artifact@v4
        with:
          name: migration-batch
          path: artifacts
